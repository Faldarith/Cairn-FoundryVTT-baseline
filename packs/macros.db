{"name":"Generate character","permission":{"default":0,"tw8WBuj1heybSIqW":3},"type":"script","flags":{"core":{"sourceId":"Macro.3zRg0cgONbT8eqmY"}},"scope":"global","command":"function formResult(input, output) {\r\n  return `<tr><td style=\'text-align:left\'><b>${input}: <\/b><\/td><td>${output}<\/td><\/tr>`;\r\n}\r\n\r\nasync function getTableAndRoll(tableName) {\r\n    let thing = await game.tables.entities.find(t => t.name === tableName).roll();\r\n    return thing.results[0].data.text.toLowerCase();\r\n}\r\n\r\nasync function Create() {\r\n  let allroll = new Roll(\"3d6[bloodmoon]+3d6[cold]+3d6[force]\").roll();\r\n\r\n  let strresults = allroll.dice[0].results;\r\n  let dexresults = allroll.dice[1].results;\r\n  let wilresults = allroll.dice[2].results;\r\n\r\n  let strength = strresults[0].result + strresults[1].result + strresults[2].result;\r\n  let dexterity = dexresults[0].result + dexresults[1].result + dexresults[2].result;\r\n  let will = wilresults[0].result + wilresults[1].result + wilresults[2].result;\r\n\r\n  let hp = new Roll(\"1d6\").roll().total;\r\n  let gold = new Roll(\"3d6\").roll().total;\r\n  let age = new Roll(\"2d10+10\").roll().total;\r\n  \/\/ name\r\n  let maleNamesTable = game.tables.entities.find(t => t.name === \"Male Names\");\r\n  let femaleNamesTable = game.tables.entities.find(t => t.name === \"Female Names\");\r\n  let genderRoll = new Roll(\"1d6\").roll().total % 2;\r\n  let firstName = \"\";\r\n  let genderTable;\r\n  if (genderRoll == 1) {\r\n    genderTable = await maleNamesTable.roll();\r\n  } else {\r\n    genderTable = await femaleNamesTable.roll();\r\n  }\r\n  firstName += genderTable.results[0].data.text;\r\n  const surnameTable = await game.tables.entities.find(t => t.name === \"Surnames\").roll();\r\n  const surname = surnameTable.results[0].data.text;\r\n  const characterName = firstName + \" \" + surname;\r\n  \/\/ biography\r\n  const face = await getTableAndRoll(\"Face\");\r\n  const hair = await getTableAndRoll(\"Hair\");\r\n  const skin = await getTableAndRoll(\"Skin\");\r\n  const physique = await getTableAndRoll(\"Physique\");\r\n  const misfortune = await getTableAndRoll(\"Misfortunes\");\r\n  const reputation = await getTableAndRoll(\"Reputation\");\r\n  const speech = await getTableAndRoll(\"Speech\");\r\n  const vice = await getTableAndRoll(\"Vice\");\r\n  const virtue = await getTableAndRoll(\"Virtue\");\r\n  const clothing = await getTableAndRoll(\"Clothing\");\r\n  const characterBackground = await getTableAndRoll(\"Background\");\r\n  let biography = `I have a <strong>${physique}<\/strong> physique, <strong>${skin}<\/strong> skin, <strong>${hair}<\/strong> hair, and a <strong>${face}<\/strong> face. I speak in a <strong>${speech}<\/strong> manner and wear <strong>${clothing}<\/strong> clothing. I am <strong>${vice}<\/strong> yet <strong>${virtue}<\/strong>, and I am generally regarded as <strong>${reputation}<\/strong>. I have had the misfortune of being <strong>${misfortune}<\/strong>. I am <strong>${age}<\/strong> years old.`;\r\n  let actorData = {\r\n    name: characterName,\r\n    background: characterBackground,\r\n    biography: biography,\r\n    hp: { value: hp, max: hp },\r\n    gold: gold,\r\n    \"abilities\": {\r\n      \"STR\": {\r\n        \"value\": strength,\r\n        \"max\": strength\r\n      },\r\n      \"DEX\": {\r\n        \"value\": dexterity,\r\n        \"max\": dexterity\r\n      },\r\n      \"WIL\": {\r\n        \"value\": will,\r\n        \"max\": will\r\n      }\r\n    },\r\n  };\r\n  let items = [];\r\n\r\n  const data = duplicate(game.items.getName(\"Rations\"));\r\n  data.data.quantity = 3;\r\n  items.push(data);\r\n\r\n  const torch = game.items.find(i => i.name === \"Torch\");\r\n  items.push(torch.data);\r\n\r\n  async function checkAndGetItemFromSubTable(name) {\r\n    if (SUB_TABLE_NAMES.includes(name)) {\r\n      let subRoll = await game.tables.getName(name).roll();\r\n      let subResults = subRoll.results;\r\n      \/\/ console.log(\"sub: \" + subresults[0].data.text);\r\n      return checkAndGetItemFromSubTable(subresults[0].data.text);\r\n    } else {\r\n      return game.items.find(i => i.name === name);\r\n    }\r\n  }\r\n\r\n  const TABLE_NAMES = [\"Trinkets\", \"Weapons\", \"Helmets and Shields\", \"Armor\", \"Expeditionary Gear\", \"Bonus Item\"];\r\n  const SUB_TABLE_NAMES = [\"Weapons\", \"Simple Weapons\", \"One-Handed Melee\", \"Ranged Weapons\", \"Two-Handed Melee\", \"Tools\", \"Trinkets\", \"Expeditionary Gear\", \"Armor\", \"Spellbooks\"]\r\n\r\n  let itemInsert = \"\";\r\n\r\n  TABLE_NAMES.forEach(async tableName => {\r\n    \/\/ console.log(\"table: \" + tableName);\r\n    let theRoll = await game.tables.getName(tableName).roll();\r\n    let results = theRoll.results;\r\n    \/\/ console.log(\"main: \" + results[0].data.text);\r\n\r\n    let item = undefined;\r\n\r\n    if(results.length){\r\n      item = await checkAndGetItemFromSubTable(results[0].data.text);\r\n    }\r\n\r\n    if (item) {\r\n      let itemClicker = \"@Item[\" + item.data.name + \"]\";\r\n      itemInsert += formResult(tableName, itemClicker);\r\n      items.push(item.data);\r\n    } else {\r\n      itemInsert += formResult(tableName, `None`);\r\n    }\r\n  });\r\n\r\n  let actor = await Actor.create({\r\n    name: characterName,\r\n    type: \"character\",\r\n    img: \"icons\/svg\/mystery-man.svg\",\r\n    sort: 12000,\r\n    data: actorData,\r\n    token: {},\r\n    items: items,\r\n    flags: {}\r\n  });\r\n\r\n  function postCharToChat() {\r\n\r\n    let statInsert = formResult(\"Strength\", strength) +\r\n      formResult(\"Dexterity\", dexterity) +\r\n      formResult(\"Will\", will) + `<\/table><table style=\"width:22%\">` +\r\n      formResult(\"HP\", hp) +\r\n      formResult(\"Gold\", gold) + \"<\/table>\";\r\n\r\n    let statsMessage = `<table style=\"width:32%\">${statInsert}<\/table>`;\r\n    let gearMessage = `<table>${itemInsert}<\/table>`;\r\n    let bioMessage = biography;\r\n\r\n    let charInsert = \"@Actor[\" + characterName + \"]\";\r\n\r\n    let chatData = {\r\n      user: game.user._id,\r\n      speaker: ChatMessage.getSpeaker(),\r\n      content: `<h2>${charInsert}<\/h2>` + statsMessage + gearMessage + bioMessage\r\n    };\r\n    ChatMessage.create(chatData, {});\r\n  }\r\n\r\n  if (game.dice3d) {\r\n    game.dice3d.showForRoll(allroll).then(happened => {\r\n      postCharToChat();\r\n\r\n    });\r\n  } else {\r\n    postCharToChat();\r\n  }\r\n\r\n};\r\nCreate();","author":"tw8WBuj1heybSIqW","img":"systems/cairn/tokens/extra/gold-piece.webp","actorIds":[],"_id":"8DgWGJnzes3jJQqk"}
